#@description flreconstruct configuration script from CD input
#@key_label  "name"
#@meta_label "type"

###########################################
# FLRECONSTRUCT PLUGINS
###########################################

[name="flreconstruct.plugins" type="flreconstruct::section"]
plugins : string[4] = "Falaise_TKReconstruct" "Falaise_ChargedParticleTracking" "CalibrationCutsModule" "SNCuts"
# "Charge2EnergyModule" 

Falaise_TKReconstruct.directory    : string = "/sps/nemo/scratch/ykozina/Falaise/tutorial/CimrmanModule/build"

CalibrationCutsModule.directory : string = "/sps/nemo/scratch/ykozina/Falaise/tutorial/CalibrationTools/build/CalibrationCutsModule"

SNCuts.directory : string = "/sps/nemo/scratch/ykozina/Falaise/tutorial/SNCuts/lib"
	
# Charge2EnergyModule.directory      : string = "/sps/nemo/scratch/ykozina/Falaise/tutorial/CalibrationTools/build/Charge2EnergyModule"

###########################################
# FLRECONSTRUCT CORE
###########################################

[name="flreconstruct" type="flreconstruct::section"]
experimentalSetupURN : string = "urn:snemo:demonstrator:setup:2.0"

[name="flreconstruct.variantService" type="flreconstruct::section"]
profile : string as path = "/sps/nemo/scratch/ykozina/Falaise/tutorial/CalibrationTools/build/CalibrationCutsModule/variant.profile" 


###########################################
# PIPELINE
###########################################

[name="pipeline" type="dpp::chain_module"]
modules : string[3] = "TKReconstruct" "ChargedParticleTracker" "SNCuts"
# "Charge2Energy" 

###########################################
# TTD 
###########################################

[name="TKReconstruct" type="TKReconstruct"]
verbosity : string = "debug"
CD_label  : string = "CD"
TCD_label : string = "TCD"
TTD_label : string = "TTD"

eventrec.verbosity : string = "debug"
eventrec.mode : string = "electron_kinked"
eventrec.visualization : boolean = false
eventrec.save_sinograms : boolean = false
eventrec.force_default_sigma_r : boolean = false
eventrec.default_sigma_r : real as length = 2.0 mm
eventrec.chi_square_threshold : real = 5.0

eventrec.clustering_max_distance : real as length = 130.0 mm
eventrec.clustering_hit_association_distance : real as length = 6.0 mm
eventrec.clustering_no_iterations : integer = 2
eventrec.clustering_resolution_phi : integer = 100
eventrec.clustering_resolution_r : integer = 250
eventrec.clustering_max_initial_precision_r : real as length = 6.0 mm
eventrec.clustering_zoom_factor : real = 10.0
eventrec.clustering_uncertainty : real as length = 2.0 mm

eventrec.polylines_max_extention_distance : real as length = 120.0 mm
eventrec.polylines_max_vertical_distance : real as length = 40.0 mm
eventrec.polylines_min_tracker_hits_distance : real as length = 100.0 mm
eventrec.polylines_max_kink_angle : real = 120.0
eventrec.polylines_max_trajectories_middlepoint_distance : real as length = 10.0 mm
eventrec.polylines_max_trajectory_endpoints_distance : real as length = 75.0 mm 
eventrec.polylines_max_trajectory_connection_angle : real = 40
eventrec.polylines_min_distance_from_foil : real as length = 75.0 mm

###########################################
# PTD 
###########################################

[name="ChargedParticleTracker" type="snemo::reconstruction::charged_particle_tracking_module"]
Geo_label : string  = "geometry"
drivers : string[4] = "VED" "CCD" "CAD" "AFD"
AFD.minimal_delayed_time : real as time = 13 us
AFD.logging.priority : string = "warning"
VED.logging.priority : string = "warning"

###########################################
# SNCuts                   
###########################################
[name="SNCuts" type="SNCuts"]

#source_pos_path : string = "/sps/nemo/scratch/ykozina/Falaise/tutorial/CimrmanModule/testing/test2/source_positions.txt"
source_pos_path : string = ""

# useEventHasTwoChargedParticles : boolean = true

# useEventHasPintAbove : boolean = true  # internal probability ToF cut
# minPint : real = 0.04

# useEventHasPextBelow : boolean = true   # external probability ToF cut
# maxPext : real = 0.30

#useEventHasSumEnergyAbove : boolean = true
#minSumEnergy : real = 600.0

#bb events cuts
	#useEventHasTwoNegativeParticles : boolean = true
	#useEventHasTwoTracks : boolean = true
	#useEventHasTwoFoilVertices : boolean = true
	useEventHasTwoCaloHits : boolean = true
	#useEventHasTwoAssociatedCaloHits : boolean = true
	#useEventHasSumEnergyAbove : boolean = true
	minSumEnergy : real = 0.0
	#useEventHasSumEnergyBelow : boolean = true
	maxSumEnergy : real = 3500.0

	#useSDBDRC : boolean = true


#calibration cuts

        #useCalibCuts : boolean = true

	#useEventHasVertexCloseToCalibSource : boolean = true
	
	#kink track cut
	#isThereKinkTrack : boolean = true
	
	#number of kinked tracks cut
	#hasNumberofKinks : string = "2 0"
	
	#1 track has 1 associated calo hit
	#useEventTrackHasOneAssocCaloHit : boolean = true
	
	#charge cut
	useEventTrackHasCaloChargeAbove : boolean = true
	caloChargeMin_nVs : real = 0.5
	#caloChargeMin_nVs : real = -1.0


	#hasNumberofTracks : string = "1"
	#hasNumberofNegativeParticles : string = "2"
	#hasNumberofFoilVertices : string = "2"
	#hasNumberofCaloHits : string = "2"



	#parameters of elips for close to calib source vertex position cut
	source_cut_ellipse_Y : real = 25.0 mm
        source_cut_ellipse_Z : real = 30.0 mm 



###########################################
# Charge2Energy 
###########################################

# [name="Charge2Energy" type="Charge2EnergyModule"]
# logging.priority : string = "information"
# gas_pressure : real = 0.89  # tracking gas pressure in bars
# He_pressure : real = 0.955  # helium
# Et_pressure : real = 0.035  # ethanol
# Ar_pressure : real = 0.01   # argon
# T_gas : real = 298.0  # tracking gas temperature in Kelvin
# calibration_path : string = "/sps/nemo/scratch/ykozina/Falaise/tutorial/CalibrationTools/Tutorial/calibration_parameters_tutorial.txt"

